# GitHub Actions å·¥ä½œæµç¨‹ï¼šè‡ªå‹•ç™¼å¸ƒ Electron æ‡‰ç”¨ç¨‹å¼
# ç•¶æ¨é€ tag (v*.*.*) æ™‚è§¸ç™¼ï¼Œè‡ªå‹•æ‰“åŒ…ä¸¦ç™¼å¸ƒåˆ° GitHub Releases

name: Release Electron App

on:
  push:
    tags:
      - 'v*.*.*'  # ç•¶æ¨é€ v1.0.0 æ ¼å¼çš„ tag æ™‚è§¸ç™¼

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

# æ˜ç¢ºçµ¦äºˆå¯«å…¥æ¬Šé™
permissions:
  contents: write

jobs:
  # åŸ·è¡Œå–®å…ƒæ¸¬è©¦
  test:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: åŸ·è¡Œå–®å…ƒæ¸¬è©¦
        working-directory: electron-client
        run: npm run test

  # å–å¾—ç‰ˆæœ¬è™Ÿ
  prepare:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: å–å¾—ç‰ˆæœ¬è™Ÿ
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

  # Windows æ‰“åŒ…
  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        working-directory: electron-client
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: æ‰“åŒ… Windows ç‰ˆæœ¬
        working-directory: electron-client
        run: npm run package:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ—å‡ºç”¢å‡ºæª”æ¡ˆ
        working-directory: electron-client/release
        run: dir

      - name: ä¸Šå‚³ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-builds
          path: |
            electron-client/release/*.exe
          retention-days: 1

  # macOS æ‰“åŒ…
  build-macos:
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        working-directory: electron-client
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: æ‰“åŒ… macOS ç‰ˆæœ¬
        working-directory: electron-client
        run: npm run package:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ—å‡ºç”¢å‡ºæª”æ¡ˆ
        working-directory: electron-client/release
        run: ls -la

      - name: ä¸Šå‚³ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            electron-client/release/*.dmg
          retention-days: 1

  # Linux æ‰“åŒ…
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        working-directory: electron-client
        run: |
          npm version ${{ needs.prepare.outputs.version }} --no-git-tag-version --allow-same-version

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: æ‰“åŒ… Linux ç‰ˆæœ¬
        working-directory: electron-client
        run: npm run package:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ—å‡ºç”¢å‡ºæª”æ¡ˆ
        working-directory: electron-client/release
        run: ls -la

      - name: ä¸Šå‚³ Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-builds
          path: |
            electron-client/release/*.AppImage
            electron-client/release/*.deb
          retention-days: 1

  # ç™¼å¸ƒ Release
  release:
    needs: [prepare, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: ä¸‹è¼‰ Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-builds
          path: artifacts/windows

      - name: ä¸‹è¼‰ macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-builds
          path: artifacts/macos

      - name: ä¸‹è¼‰ Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-builds
          path: artifacts/linux

      - name: åˆ—å‡ºæ‰€æœ‰ Artifacts
        run: |
          echo "=== Windows ==="
          ls -la artifacts/windows/
          echo "=== macOS ==="
          ls -la artifacts/macos/
          echo "=== Linux ==="
          ls -la artifacts/linux/

      - name: å»ºç«‹ GitHub Release ä¸¦ä¸Šå‚³æª”æ¡ˆ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: é€šçŸ¥ç›£æ§ç¨‹å¼ v${{ needs.prepare.outputs.version }}
          body: |
            ## é€šçŸ¥ç›£æ§ç¨‹å¼ v${{ needs.prepare.outputs.version }}
            
            ### ä¸‹è¼‰
            | å¹³å° | é¡å‹ | æª”æ¡ˆ |
            |------|------|------|
            | Windows | å®‰è£ç‰ˆ | `NotificationClient-Setup-${{ needs.prepare.outputs.version }}.exe` |
            | Windows | å…å®‰è£ç‰ˆ | `NotificationClient-Portable-${{ needs.prepare.outputs.version }}.exe` |
            | macOS | å®‰è£æª” | `NotificationClient-${{ needs.prepare.outputs.version }}-mac.dmg` |
            | Linux | AppImage | `NotificationClient-${{ needs.prepare.outputs.version }}-linux.AppImage` |
            | Linux | DEB | `NotificationClient-${{ needs.prepare.outputs.version }}-linux-amd64.deb` |
            
            ### æ›´æ–°å…§å®¹
            è«‹æŸ¥çœ‹ [CHANGELOG](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) äº†è§£è©³ç´°æ›´æ–°å…§å®¹ã€‚
          files: |
            artifacts/windows/*.exe
            artifacts/macos/*.dmg
            artifacts/linux/*.AppImage
            artifacts/linux/*.deb
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ç™¼é€ç™¼å¸ƒæˆåŠŸé€šçŸ¥
  notify-release:
    needs: [prepare, release]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: ç™¼é€ CI/CD é€šçŸ¥
        run: |
          curl -X POST https://notify.try-8verything.com/api/notifications/windows \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.NOTIFY_API_KEY }}" \
            -d '{
              "title": "ğŸš€ Release Success",
              "message": "é€šçŸ¥ç›£æ§ç¨‹å¼ v${{ needs.prepare.outputs.version }} å·²æˆåŠŸç™¼å¸ƒè‡³æ‰€æœ‰å¹³å° (Windows, macOS, Linux)",
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit_sha": "${{ github.sha }}",
              "action_url": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }}"
            }'
