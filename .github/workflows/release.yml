# GitHub Actions å·¥ä½œæµç¨‹ï¼šè‡ªå‹•ç™¼å¸ƒ Electron æ‡‰ç”¨ç¨‹å¼
# ç•¶æ¨é€ tag (v*.*.*) æ™‚è§¸ç™¼ï¼Œè‡ªå‹•æ‰“åŒ…ä¸¦ç™¼å¸ƒåˆ° GitHub Releases

name: Release Electron App

on:
  push:
    tags:
      - 'v*.*.*'  # ç•¶æ¨é€ v1.0.0 æ ¼å¼çš„ tag æ™‚è§¸ç™¼

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

# æ˜ç¢ºçµ¦äºˆå¯«å…¥æ¬Šé™ï¼Œè§£æ±º "Resource not accessible by integration" éŒ¯èª¤
permissions:
  contents: write

jobs:
  # å»ºç«‹ Release
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: å–å¾—ç‰ˆæœ¬è™Ÿ
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: å»ºç«‹ GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: é€šçŸ¥ç›£æ§ç¨‹å¼ v${{ steps.get_version.outputs.version }}
          body: |
            ## é€šçŸ¥ç›£æ§ç¨‹å¼ v${{ steps.get_version.outputs.version }}
            
            ### ä¸‹è¼‰
            | å¹³å° | é¡å‹ | æª”æ¡ˆ |
            |------|------|------|
            | Windows | å®‰è£ç‰ˆ | `NotificationClient-Setup-${{ steps.get_version.outputs.version }}.exe` |
            | Windows | å…å®‰è£ç‰ˆ | `NotificationClient-Portable-${{ steps.get_version.outputs.version }}.exe` |
            | macOS | å®‰è£æª” | `NotificationClient-${{ steps.get_version.outputs.version }}-mac.dmg` |
            | Linux | AppImage | `NotificationClient-${{ steps.get_version.outputs.version }}-linux.AppImage` |
            | Linux | DEB | `NotificationClient-${{ steps.get_version.outputs.version }}-linux-amd64.deb` |
            
            ### æ›´æ–°å…§å®¹
            è«‹æŸ¥çœ‹ [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è©³ç´°æ›´æ–°å…§å®¹ã€‚
          draft: false
          prerelease: false

  # Windows æ‰“åŒ…
  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        working-directory: electron-client
        run: |
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version --allow-same-version

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: æ‰“åŒ… Windows ç‰ˆæœ¬
        working-directory: electron-client
        run: npm run package:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ—å‡ºç”¢å‡ºæª”æ¡ˆ
        working-directory: electron-client/release
        run: dir

      - name: ä¸Šå‚³ Windows å®‰è£æª” (NSIS)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: electron-client/release/NotificationClient-Setup-${{ needs.create-release.outputs.version }}.exe
          asset_name: NotificationClient-Setup-${{ needs.create-release.outputs.version }}.exe
          asset_content_type: application/octet-stream

      - name: ä¸Šå‚³ Windows å…å®‰è£ç‰ˆ (Portable)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: electron-client/release/NotificationClient-Portable-${{ needs.create-release.outputs.version }}.exe
          asset_name: NotificationClient-Portable-${{ needs.create-release.outputs.version }}.exe
          asset_content_type: application/octet-stream

  # macOS æ‰“åŒ…
  build-macos:
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        working-directory: electron-client
        run: |
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version --allow-same-version

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: æ‰“åŒ… macOS ç‰ˆæœ¬
        working-directory: electron-client
        run: npm run package:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ—å‡ºç”¢å‡ºæª”æ¡ˆ
        working-directory: electron-client/release
        run: ls -la

      - name: ä¸Šå‚³ macOS DMG
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: electron-client/release/NotificationClient-${{ needs.create-release.outputs.version }}-mac.dmg
          asset_name: NotificationClient-${{ needs.create-release.outputs.version }}-mac.dmg
          asset_content_type: application/octet-stream

  # Linux æ‰“åŒ…
  build-linux:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: electron-client/package-lock.json

      - name: æ›´æ–°ç‰ˆæœ¬è™Ÿ
        working-directory: electron-client
        run: |
          npm version ${{ needs.create-release.outputs.version }} --no-git-tag-version --allow-same-version

      - name: å®‰è£ä¾è³´
        working-directory: electron-client
        run: npm ci

      - name: æ‰“åŒ… Linux ç‰ˆæœ¬
        working-directory: electron-client
        run: npm run package:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ—å‡ºç”¢å‡ºæª”æ¡ˆ
        working-directory: electron-client/release
        run: ls -la

      - name: ä¸Šå‚³ Linux AppImage
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: electron-client/release/NotificationClient-${{ needs.create-release.outputs.version }}-linux.AppImage
          asset_name: NotificationClient-${{ needs.create-release.outputs.version }}-linux.AppImage
          asset_content_type: application/octet-stream

      - name: ä¸Šå‚³ Linux DEB
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: electron-client/release/NotificationClient-${{ needs.create-release.outputs.version }}-linux-amd64.deb
          asset_name: NotificationClient-${{ needs.create-release.outputs.version }}-linux-amd64.deb
          asset_content_type: application/octet-stream

  # ç™¼é€ç™¼å¸ƒæˆåŠŸé€šçŸ¥
  notify-release:
    needs: [create-release, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: ç™¼é€ CI/CD é€šçŸ¥
        run: |
          curl -X POST https://notify.try-8verything.com/api/notifications/windows \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.NOTIFY_API_KEY }}" \
            -d '{
              "title": "ğŸš€ Release Success",
              "message": "é€šçŸ¥ç›£æ§ç¨‹å¼ v${{ needs.create-release.outputs.version }} å·²æˆåŠŸç™¼å¸ƒè‡³æ‰€æœ‰å¹³å° (Windows, macOS, Linux)",
              "repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit_sha": "${{ github.sha }}",
              "action_url": "https://github.com/${{ github.repository }}/releases/tag/v${{ needs.create-release.outputs.version }}"
            }'
